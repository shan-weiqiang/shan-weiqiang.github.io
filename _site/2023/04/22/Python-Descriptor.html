<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Python descriptors | shanweiqiang’s blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Python descriptors" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Python descriptor is the mechanism behind instance method, classmethod, staticmethod, property. Also descriptor plays a key role in attribute lookup order. This article tries to explain descriptor as detailed as possible, hoping to save some time for anyone who are interested in this topic, since I myself spend a lot of time searching over the web about descriptor. However, even though information are there, there is not one place where I can know them all. This article tries to solve this problem." />
<meta property="og:description" content="Python descriptor is the mechanism behind instance method, classmethod, staticmethod, property. Also descriptor plays a key role in attribute lookup order. This article tries to explain descriptor as detailed as possible, hoping to save some time for anyone who are interested in this topic, since I myself spend a lot of time searching over the web about descriptor. However, even though information are there, there is not one place where I can know them all. This article tries to solve this problem." />
<link rel="canonical" href="http://localhost:4000/2023/04/22/Python-Descriptor.html" />
<meta property="og:url" content="http://localhost:4000/2023/04/22/Python-Descriptor.html" />
<meta property="og:site_name" content="shanweiqiang’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-22T19:22:46+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Python descriptors" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-22T19:22:46+08:00","datePublished":"2023-04-22T19:22:46+08:00","description":"Python descriptor is the mechanism behind instance method, classmethod, staticmethod, property. Also descriptor plays a key role in attribute lookup order. This article tries to explain descriptor as detailed as possible, hoping to save some time for anyone who are interested in this topic, since I myself spend a lot of time searching over the web about descriptor. However, even though information are there, there is not one place where I can know them all. This article tries to solve this problem.","headline":"Python descriptors","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2023/04/22/Python-Descriptor.html"},"url":"http://localhost:4000/2023/04/22/Python-Descriptor.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="shanweiqiang&apos;s blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">shanweiqiang&#39;s blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tags/">tags</a><a class="page-link" href="/about/">about</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Python descriptors</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-04-22T19:22:46+08:00" itemprop="datePublished">Apr 22, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Python descriptor is the mechanism behind instance method, classmethod, staticmethod, property. Also descriptor plays a key role in attribute lookup order. This article tries to explain descriptor as detailed as possible, hoping to save some time for anyone who are interested in this topic, since I myself spend a lot of time searching over the web about descriptor. However, even though information are there, there is not one place where I can know them all. This article tries to solve this problem.</p>

<ul id="markdown-toc">
  <li><a href="#time-saver" id="markdown-toc-time-saver">Time saver</a></li>
  <li><a href="#what-is-descriptor" id="markdown-toc-what-is-descriptor">What is descriptor?</a>    <ul>
      <li><a href="#category-of-descriptor" id="markdown-toc-category-of-descriptor">Category of descriptor</a></li>
      <li><a href="#what-is-the-use-of-__set_name__-method" id="markdown-toc-what-is-the-use-of-__set_name__-method">What is the use of <code class="language-plaintext highlighter-rouge">__set_name__</code> method？</a></li>
    </ul>
  </li>
  <li><a href="#python-attribute-lookup-order" id="markdown-toc-python-attribute-lookup-order">Python attribute lookup order</a>    <ul>
      <li><a href="#the-lookup-order-diagram" id="markdown-toc-the-lookup-order-diagram">The lookup order diagram</a></li>
      <li><a href="#explanation" id="markdown-toc-explanation">Explanation</a></li>
      <li><a href="#example" id="markdown-toc-example">Example</a></li>
    </ul>
  </li>
  <li><a href="#refresh-our-python-concept" id="markdown-toc-refresh-our-python-concept">Refresh our Python concept</a>    <ul>
      <li><a href="#functions-and-methods" id="markdown-toc-functions-and-methods">Functions and methods</a></li>
      <li><a href="#classmethod" id="markdown-toc-classmethod">@classmethod</a></li>
      <li><a href="#staticmethod" id="markdown-toc-staticmethod">@staticmethod</a></li>
      <li><a href="#property" id="markdown-toc-property">@property</a>        <ul>
          <li><a href="#property-is-a-data-descriptor" id="markdown-toc-property-is-a-data-descriptor">property is a data descriptor</a></li>
          <li><a href="#with-a-little-syntactic-sugarproperty-decorators" id="markdown-toc-with-a-little-syntactic-sugarproperty-decorators">With a little syntactic sugar—@property decorators</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a></li>
</ul>

<h1 id="time-saver">Time saver</h1>

<p>Of course, the final interpretation always belongs to official documentation. If you can read and understand following link without difficulties, then do not waste time reading this paper anymore.</p>

<p><a href="https://docs.python.org/3/howto/descriptor.html">Descriptor HowTo Guide</a></p>

<h1 id="what-is-descriptor">What is descriptor?</h1>

<p>Facts about descriptor:</p>

<ul>
  <li>A class is called descriptor if it implements <strong>one or more</strong> of following methods:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">__get__(self, obj, type=None) -&gt; object</code></li>
      <li><code class="language-plaintext highlighter-rouge">__set__(self, obj, value) -&gt; None</code></li>
      <li><code class="language-plaintext highlighter-rouge">__delete__(self, obj) -&gt; None</code></li>
    </ul>
  </li>
  <li>For descriptors to work, it has to be class variable of another class</li>
  <li>When descriptor variables are accessed using dotted expression, <code class="language-plaintext highlighter-rouge">__get__</code> method is called</li>
  <li>When descriptor variables are set using dotted expression, <code class="language-plaintext highlighter-rouge">__set__</code> method is called</li>
  <li>When descriptor is accessed, the parameters are passed to methods automatically</li>
</ul>

<p>Nothing says more than examples, here is code example that explains what is descriptor and how it is accessed:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeDescriptor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Descriptor class</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Called when descriptor is accessed

        Parameters:
            self: descriptor instance
            obj:  instance to which this descriptor instance belongs
            obj_type: instance class type to which this descriptor instance belongs
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Called when descriptor is set

        Parameters:
            self: descriptor instance
            obj:  instance to which this descriptor instance belongs
            value: value that about to set
        </span><span class="sh">"""</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Descriptor is being set</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Some class that use descriptor</span><span class="sh">"""</span>

    <span class="c1"># descriptor has to be class variable to work
</span>    <span class="n">dsp</span> <span class="o">=</span> <span class="nc">SomeDescriptor</span><span class="p">()</span>

<span class="n">ins</span> <span class="o">=</span> <span class="nc">SomeClass</span><span class="p">()</span>
<span class="c1"># ins.dsp calls __get__ and return 42
</span><span class="nf">print</span><span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">dsp</span><span class="p">)</span>
<span class="c1"># ins.dsp set to 6 will call __set__
</span><span class="n">ins</span><span class="p">.</span><span class="n">dsp</span> <span class="o">=</span> <span class="mi">6</span>
</code></pre></div></div>

<p>Output:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">42</span>
<span class="n">Descriptor</span> <span class="ow">is</span> <span class="n">being</span> <span class="nb">set</span>
</code></pre></div></div>

<p>Note that when <code class="language-plaintext highlighter-rouge">__set__</code> and <code class="language-plaintext highlighter-rouge">__get__</code> are called, the parameters are passed automatically</p>

<h2 id="category-of-descriptor">Category of descriptor</h2>

<ul>
  <li>Non-data descriptors: descriptors that only implement <code class="language-plaintext highlighter-rouge">__get__</code> method</li>
  <li>Data descriptors: descriptors that implement <code class="language-plaintext highlighter-rouge">__set__</code> or <code class="language-plaintext highlighter-rouge">__delete__</code> method</li>
</ul>

<p>Data and non-data descriptors will have influence on attribute lookup order in follow chapters.</p>

<h2 id="what-is-the-use-of-__set_name__-method">What is the use of <code class="language-plaintext highlighter-rouge">__set_name__</code> method？</h2>

<p>Key information about <code class="language-plaintext highlighter-rouge">__set_name__(self, owner, name)</code> :</p>

<ul>
  <li>This method is used to let the descriptor know what name it is assigned to</li>
  <li>It’s called when class is defined  as a callback</li>
</ul>

<p>Here is an example to show how <code class="language-plaintext highlighter-rouge">__set_name__</code> works:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeDescriptor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Descriptor class</span><span class="sh">"""</span>

    <span class="c1"># This method will be called when class SomeClass is defined
</span>    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Let self know what variable name it is assigned</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">self_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">self_name</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Called when descriptor is accessed

        Parameters:
            self: descriptor instance
            obj:  instance to which this descriptor instance belongs
            obj_type: instance class type to which this descriptor instance belongs
        </span><span class="sh">"""</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Called when descriptor is set

        Parameters:
            self: descriptor instance
            obj:  instance to which this descriptor instance belongs
            value: value that about to set
        </span><span class="sh">"""</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Descriptor is being set</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Some class that use descriptor</span><span class="sh">"""</span>

    <span class="c1"># descriptor has to be class variable to work
</span>    <span class="n">dsp</span> <span class="o">=</span> <span class="nc">SomeDescriptor</span><span class="p">()</span>
</code></pre></div></div>

<p>Output:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dsp</span> <span class="c1"># The descriptor instance now know that it is assigned name 'dsp'
</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">__main__</span><span class="p">.</span><span class="n">SomeClass</span><span class="sh">'</span><span class="s">&gt;
</span></code></pre></div></div>

<p>What is interesting about this output is that in our Python code there is no statement, only definitions, which demonstrates that the <code class="language-plaintext highlighter-rouge">__set_name__</code> method is called when <code class="language-plaintext highlighter-rouge">SomeClass</code> is <em>defined</em>.</p>

<h1 id="python-attribute-lookup-order">Python attribute lookup order</h1>

<p>First of all, everything in Python is <code class="language-plaintext highlighter-rouge">object</code> . <code class="language-plaintext highlighter-rouge">object</code> have <code class="language-plaintext highlighter-rouge">attribute</code> . <code class="language-plaintext highlighter-rouge">attribute</code> can be accessed by dotted expression, such as <code class="language-plaintext highlighter-rouge">a.b</code> or by <code class="language-plaintext highlighter-rouge">object.__getattribute__()</code> method. The problem is when tries to access attribute with a specific name, how Python lookup this attribute internally and what is the priority queue？I try to answer this question first with a diagram and then explanation, finally with example to demonstrate.</p>

<h2 id="the-lookup-order-diagram">The lookup order diagram</h2>

<p>Here is how an instance of type <code class="language-plaintext highlighter-rouge">SomeClass</code> named <code class="language-plaintext highlighter-rouge">ins</code> tries to access attribute named <code class="language-plaintext highlighter-rouge">dsp</code> in our previous example. Always remember everything in Python is <code class="language-plaintext highlighter-rouge">object</code> and <code class="language-plaintext highlighter-rouge">SomeClass</code> and <code class="language-plaintext highlighter-rouge">ins</code> are all <code class="language-plaintext highlighter-rouge">object</code> by themselves and has their own attributes.</p>

<p><img src="/assets/images/Python_attribute_lookup_order.drawio.png" alt="Python_attribute_lookup_order.drawio.png" /></p>

<h2 id="explanation">Explanation</h2>

<p>In the diagram, from top to down:</p>

<ol>
  <li>Everything starts with <code class="language-plaintext highlighter-rouge">__getattribute__</code> method</li>
  <li>Check whether ‘dsp’ is one of the attributes of <code class="language-plaintext highlighter-rouge">SomeClass</code>, note that this include all attributes inherited from parent classes</li>
  <li>If yes in above step, check whether it’s a data descriptor, if yes return:
    <ol>
      <li>return <code class="language-plaintext highlighter-rouge">__get__</code> method result if it has this method</li>
      <li>return this object if no <code class="language-plaintext highlighter-rouge">__get__</code> method</li>
    </ol>
  </li>
  <li>Check if ‘dsp’ is instance attribute, if yes return this attribute</li>
  <li>Check again whether ‘dsp’ is one of attribute of <code class="language-plaintext highlighter-rouge">SomeClass</code>, this time check whether it’s non-data descriptor:
    <ol>
      <li>return <code class="language-plaintext highlighter-rouge">__get__</code> method result if has this method(non-data descriptor)</li>
      <li>return this object if no <code class="language-plaintext highlighter-rouge">__get__</code> method</li>
    </ol>
  </li>
  <li>Call user defined back up method <code class="language-plaintext highlighter-rouge">__getattr__</code> if it’s defined</li>
  <li>Raise <code class="language-plaintext highlighter-rouge">AttributeError</code></li>
</ol>

<h2 id="example">Example</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DataDescriptor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">data descriptor</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">self_name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Descriptor is being set</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NonDataDescriptor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">non-data descriptor</span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">Some class that use descriptor</span><span class="sh">"""</span>

    <span class="c1"># This descriptor has highest access priority
</span>    <span class="n">dsp</span> <span class="o">=</span> <span class="nc">DataDescriptor</span><span class="p">()</span>
    <span class="c1"># This access priority is below instance variables
</span>    <span class="n">ndsp</span> <span class="o">=</span> <span class="nc">NonDataDescriptor</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dsp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Tom</span><span class="sh">'</span>  <span class="c1"># This dsp is a descriptor
</span>        <span class="n">self</span><span class="p">.</span><span class="n">ndsp</span> <span class="o">=</span> <span class="sh">'</span><span class="s">Jerry</span><span class="sh">'</span>  <span class="c1"># This ndsp is not a descriptor, it's instance variable
</span>
<span class="n">ins</span> <span class="o">=</span> <span class="nc">SomeClass</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">dsp</span><span class="p">)</span>  <span class="c1"># 42
</span><span class="nf">print</span><span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">ndsp</span><span class="p">)</span>  <span class="c1"># 'Jerry'
</span></code></pre></div></div>

<p>Output:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Descriptor</span> <span class="ow">is</span> <span class="n">being</span> <span class="nb">set</span>
<span class="mi">42</span>
<span class="n">Jerry</span>
</code></pre></div></div>

<h1 id="refresh-our-python-concept">Refresh our Python concept</h1>

<p>With knowledge of descriptors we can have a deeper understanding of many Python basic concept and how they work under the hood.</p>

<h2 id="functions-and-methods">Functions and methods</h2>

<p>The only difference between functions and methods is methods have the first argument reserved for instance. In Python everything is <code class="language-plaintext highlighter-rouge">object</code>, so does functions and methods.</p>

<p>Here is the Python implementation of function and method in the official doc:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is method class
</span><span class="o">**</span><span class="k">class</span> <span class="nc">MethodType</span><span class="p">:</span>
    <span class="sh">"</span><span class="s">Emulate PyMethod_Type in Objects/classobject.c</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">__func__</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">self</span><span class="p">.</span><span class="n">__self__</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">__func__</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">__self__</span>
        <span class="k">return</span> <span class="nf">func</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1"># This is function class
</span><span class="k">class</span> <span class="nc">Function</span><span class="p">:</span>
    <span class="bp">...</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sh">"</span><span class="s">Simulate func_descr_get() in Objects/funcobject.c</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span>
        <span class="k">return</span> <span class="nc">MethodType</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span><span class="o">**</span>
</code></pre></div></div>

<p>From the code we can draw following conclusions:</p>

<ul>
  <li>Functions are non-data descriptors</li>
  <li>When we define a method in class, we actually create a non-data descriptor</li>
  <li>When we call the method, we actually access the non-data descriptor by calling the <code class="language-plaintext highlighter-rouge">__get__</code> method of Function, this method returns a <code class="language-plaintext highlighter-rouge">MethodType</code> that is a callable and will pass the instance as the first argument to the function together with other arguments.</li>
</ul>

<h2 id="classmethod">@classmethod</h2>

<p>The @classmethod decorator turns the functions user defined into a non-data descriptor of type <code class="language-plaintext highlighter-rouge">ClassMethod</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simplified implementation of ClassMethod
</span><span class="k">class</span> <span class="nc">ClassMethod</span><span class="p">:</span>
    <span class="sh">"</span><span class="s">Emulate PyClassMethod_Type() in Objects/funcobject.c</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="nf">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="nc">MethodType</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">f</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>
</code></pre></div></div>

<p>From the code we can clearly see that the only difference between instance method and class method is that instance method when accessed returns a <code class="language-plaintext highlighter-rouge">MethodType</code> that accept instance <code class="language-plaintext highlighter-rouge">self</code> as parameter while class method when access returns a <code class="language-plaintext highlighter-rouge">MethodType</code> that accept class instance <code class="language-plaintext highlighter-rouge">cls</code> as parameter. Except for that, there is no other differences.</p>

<h2 id="staticmethod">@staticmethod</h2>

<p>The @staticmethod decorator turns the functions user defined into a non-data descriptor of type <code class="language-plaintext highlighter-rouge">StaticMethod</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StaticMethod</span><span class="p">:</span>
    <span class="sh">"</span><span class="s">Emulate PyStaticMethod_Type() in Objects/funcobject.c</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">f</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</code></pre></div></div>

<p>This descriptor do not use <code class="language-plaintext highlighter-rouge">obj</code> and <code class="language-plaintext highlighter-rouge">objtype</code> parameter, which means is does not pass instance or class object to the function. This means the function has nothing to do with this class, except that itself is a descriptor of the class.</p>

<h2 id="property">@property</h2>

<h3 id="property-is-a-data-descriptor">property is a data descriptor</h3>

<p><code class="language-plaintext highlighter-rouge">property</code> class is a data descriptor class that implement descriptor protocol method that can wrap functions inside them</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="n">cate</span> <span class="o">=</span> <span class="sh">'</span><span class="s">People</span><span class="sh">'</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">getter method called</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">setter method called</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">can not set</span><span class="sh">'</span><span class="p">)</span>

    <span class="c1"># Here property is a class that implement descriptor protocol
</span>    <span class="c1"># getter and setter functions are passed to property class memebers and will be called in  __get__ and __set__
</span>    <span class="c1"># function. So when attr is accessed throuth dot, getter and setter will be called
</span>    <span class="c1"># Note that when accessed using dot, the owner class instance and class will be passed to __get__ and __set__
</span>    <span class="c1"># then getter and setter parameters will be managed inside __get__ and __set__
</span>    <span class="c1"># This already sounds very much like decorators.
</span>    <span class="n">attr</span> <span class="o">=</span> <span class="nf">property</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">)</span>

<span class="n">some</span> <span class="o">=</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="sh">'</span><span class="s">Tom</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Call getter
</span><span class="n">x</span> <span class="o">=</span> <span class="n">some</span><span class="p">.</span><span class="n">attr</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># Call setter
</span><span class="n">some</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="mi">5</span>
<span class="nf">print</span><span class="p">(</span><span class="n">some</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span>
</code></pre></div></div>

<p>Output:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getter</span> <span class="n">method</span> <span class="n">called</span>
<span class="mi">42</span>
<span class="n">setter</span> <span class="n">method</span> <span class="n">called</span>
<span class="nc">Traceback </span><span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="sh">"</span><span class="s">/Users/shanweiqiang/sketch/test.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">29</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">some</span><span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="n">File</span> <span class="sh">"</span><span class="s">/Users/shanweiqiang/sketch/test.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">13</span><span class="p">,</span> <span class="ow">in</span> <span class="n">setter</span>
    <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">can not set</span><span class="sh">'</span><span class="p">)</span>
<span class="nb">Exception</span><span class="p">:</span> <span class="n">can</span> <span class="ow">not</span> <span class="nb">set</span>
</code></pre></div></div>

<h3 id="with-a-little-syntactic-sugarproperty-decorators">With a little syntactic sugar—@property decorators</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="n">cate</span> <span class="o">=</span> <span class="sh">'</span><span class="s">People</span><span class="sh">'</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="c1"># Here the @property decorator convert 'getter' into a descriptor of SomeClass
</span>    <span class="c1"># 'property' is itself a decorator that implement descriptor protocol
</span>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">getter method called</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">42</span>

    <span class="c1"># 'getter' is alreay a descriptor, here use the method setter to decorate 'setter' of SomeClass
</span>    <span class="c1"># Note the two 'setter' names:
</span>        <span class="c1"># in @getter.setter, the setter is method of class property
</span>        <span class="c1"># in def setter(..).., the setter is method of SomeClass, this method will be registered into 'getter' descriptor, the name doesn't really matters here
</span>    <span class="nd">@getter.setter</span>
    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">setter method called</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">can not set</span><span class="sh">'</span><span class="p">)</span>

<span class="n">some</span> <span class="o">=</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="sh">'</span><span class="s">Tom</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Equals: some.getter.__get__(..)
</span><span class="n">x</span> <span class="o">=</span> <span class="n">some</span><span class="p">.</span><span class="n">getter</span>
<span class="nf">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># Equals: some.getter.__set__(..)
</span><span class="n">some</span><span class="p">.</span><span class="n">setter</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nf">print</span><span class="p">(</span><span class="n">some</span><span class="p">.</span><span class="n">getter</span><span class="p">)</span>
</code></pre></div></div>

<p>Output:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getter</span> <span class="n">method</span> <span class="n">called</span>
<span class="mi">42</span>
<span class="n">setter</span> <span class="n">method</span> <span class="n">called</span>
<span class="nc">Traceback </span><span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="sh">"</span><span class="s">/Users/shanweiqiang/sketch/test.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">29</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">some</span><span class="p">.</span><span class="n">setter</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">File</span> <span class="sh">"</span><span class="s">/Users/shanweiqiang/sketch/test.py</span><span class="sh">"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">21</span><span class="p">,</span> <span class="ow">in</span> <span class="n">setter</span>
    <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">can not set</span><span class="sh">'</span><span class="p">)</span>
<span class="nb">Exception</span><span class="p">:</span> <span class="n">can</span> <span class="ow">not</span> <span class="nb">set</span>
</code></pre></div></div>

<h1 id="summary">Summary</h1>

<p>Descriptor is the mechanism behind some Python features. Knowing them is not a prerequisite to use Python. But understanding them can help to write more concise and structured code. In the end it’s for the curious.</p>

  </div><a class="u-url" href="/2023/04/22/Python-Descriptor.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">shanweiqiang&#39;s blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">shanweiqiang&#39;s blog</li><li><a class="u-email" href="mailto:schmessi@163.com">schmessi@163.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/shan-weiqiang"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">shan-weiqiang</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
